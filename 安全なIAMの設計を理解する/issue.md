# 課題 1

## IAM 　とは

- AWS Identity and Access Management (IAM) は、AWS リソースへのアクセスを安全に管理するためのウェブサービス
- IAM を使用すると、ユーザーがアクセスできる AWS のリソースを制御するアクセス許可を集中管理できる
- IAM により、誰を認証 (サインイン) し、誰にリソースの使用を承認する (アクセス許可を持たせる) かを制御する
- AWS アカウント を作成する場合は、このアカウントのすべての AWS のサービス とリソースに対して完全なアクセス権を持つ 1 つのサインインアイデンティティから始める
- この ID は AWS アカウント ルートユーザーと呼ばれ、アカウントの作成に使用した E メールアドレスとパスワードでサインインすることによってアクセスできる
- 日常的なタスクには、ルートユーザーを使用しないことを強くお勧めする。代わりに管理ユーザーを作成すると良い。
- ルートユーザーの認証情報を保護し、それらを使用してルートユーザーのみが実行できるタスクを実行する

## IAM ユーザ

- 1 人のユーザーまたは 1 つのアプリケーションに対して特定の許可を持つ AWS アカウント 内のアイデンティティ
- パスワードやアクセスキーなどの長期的な認証情報を保有する IAM ユーザーを作成する代わりに、一時的な認証情報を使用することをお勧め
- ただし、IAM ユーザーとの長期的な認証情報が必要な特定のユースケースがある場合は、アクセスキーをローテーションすることをお勧め
- ユーザーは、ロールとは異なる
- ユーザーは 1 人の人または 1 つのアプリケーションに一意に関連付けられますが、ロールはそれを必要とする任意の人が引き受けるようになっている
- ユーザーには永続的な長期の認証情報があるが、ロールでは一時的な認証情報が提供される

## IAM グループ

- IAM ユーザーの集団を指定するアイデンティティ
- グループとしてサインインすることはできない
- グループを使用して、複数のユーザーに対して一度に許可を指定できる
- 多数のユーザーグループがある場合、グループを使用することで許可の管理が容易になる
- 例えば、IAMAdmins という名前のグループを設定して、そのグループに IAM リソースを管理する許可を与えることができる

## IAM ポリシー

- AWS でのアクセスを管理するには、ポリシーを作成し、IAM アイデンティティ (ユーザー、ユーザーのグループ、ロール) または AWS リソースにアタッチする
- ポリシーは AWS のオブジェクトであり、アイデンティティやリソースに関連付けて、これらのアクセス許可を定義する
- AWS は、IAM プリンシパル (ユーザーまたはロール) によってリクエストが行われると、それらのポリシーを評価する
- ポリシーでの許可により、リクエストが許可されるか拒否されるかが決まる
- 通常、ポリシーは JSON ドキュメントとして AWS に保存される
- AWS は、6 つのポリシータイプ (アイデンティティベースのポリシー、リソースベースのポリシー、アクセス許可の境界、 SCP、ACL、セッションポリシー) をサポートする
- IAM ポリシーは、オペレーションの実行方法を問わず、アクションの許可を定義する
- 例えば、GetUser アクションを許可するポリシーを適用されたユーザーは、AWS Management Console、AWS CLI、または AWS API からユーザー情報を取得できる
- IAM ユーザーを作成したら、コンソールまたはプログラムによるアクセスを許可するように選択できる
- コンソールへのアクセスが許可されている場合、IAM ユーザーは、サインイン認証情報を使用してコンソールにサインインできる
- プログラムによるアクセスが許可されている場合、ユーザーは、アクセスキーで CLI または API を使用する

## IAM ロール

- IAM ロールは、特定の許可があり、アカウントで作成できるもう 1 つの IAM アイデンティティ
- IAM ロールは、アイデンティティが AWS で実行できることとできないことを決定するアクセス許可ポリシーを持つ AWS アイデンティティであるという点で IAM ユーザーと似ている
- ただし、ユーザーは 1 人の特定の人に一意に関連付けられますが、ロールはそれを必要とする任意の人が引き受けるようになっている
- また、ロールには標準の長期認証情報 (パスワードやアクセスキーなど) も関連付けられない
- 代わりに、ロールを引き受けると、ロールセッション用の一時的なセキュリティ認証情報が提供される

## Permission boundary（アクセス許可境界）

- AWS アカウント 内の IAM ユーザーのアクセス許可を変更するには、グループメンバーシップを変更するか、既存のユーザーからアクセス許可をコピーするか、ユーザーに直接ポリシーをアタッチするか、またはアクセス許可の境界を設定することができる
- アクセス許可の境界では、ユーザーに許可されるアクセス許可の上限を設定できる

## AWS 管理ポリシー

- AWS 管理ポリシーは、AWS が作成および管理するスタンドアロンポリシー
- スタンドアロンポリシーとは、ポリシー名を含む独自の Amazon リソースネーム (ARN) の付いたポリシー
- たとえば、arn:aws:iam::aws:policy/IAMReadOnlyAccess は AWS 管理ポリシー
- AWS 管理ポリシーは、ユーザー、グループおよびロールに適切な権限を割り当てるのに便利
- ポリシーを自分で作成するよりも簡単で、多くの一般的なユースケースに対応したアクセス許可が含まれている
- AWS 管理ポリシーで定義されているアクセス許可は変更できない
- AWS は、AWS 管理ポリシーで定義されているアクセス許可を不定期に更新する
- AWS によるこの更新は、ポリシーがアタッチされているすべてのプリンシパルエンティティ (ユーザー、グループ、およびロール) に影響を与える
- AWS は、新しい AWS サービスが開始されたときや既存のサービスで新しい API コールが利用可能になったときに、AWS 管理ポリシーを更新する可能性が最も高くなる
- たとえば、ReadOnlyAccess という AWS 管理ポリシーでは、すべての AWS サービスおよびリソースへの読み取り専用アクセスが許可される
- AWS は新しいサービスを開始すると、AWS により ReadOnlyAccess ポリシーを更新して、新しいサービスに対する読み取り専用アクセス許可を追加する
- 更新されたアクセス権限は、ポリシーがアタッチされているすべてのプリンシパルエンティティに適用される

## カスタマー管理ポリシー

- プリンシパルエンティティ (ユーザー、グループ、ロール) にアタッチできる単独のポリシーを独自の AWS アカウント に作成することができる
- これらのカスタマー管理ポリシーは、特定のユースケースに合わせて作成し、何度でも変更および更新が可能
- AWS 管理ポリシーのように、プリンシパルエンティティにアタッチすると、ポリシーで定義されたアクセス権限がエンティティに付与される
- ポリシーに含まれるアクセス許可が更新されると、その変更はポリシーがアタッチされているすべてのプリンシパルエンティティに適用されます。
- お客様が管理するポリシーを作成する優れた方法は、既存の AWS 管理ポリシーをコピーして開始すること
- この方法で、最初の段階でポリシーが正しいことがわかっていれば、ご使用の環境に合わせて必要なカスタマイズを行うことができる

## ホワイトリストパターン、ブラックリストパターン

- AWS IAM におけるホワイトリストパターンは、一般的に特定のユーザーやロールが特定の AWS リソースへのアクセスを許可されるパターンを指す。たとえば、特定の S3 バケットへの読み取りアクセスを特定のユーザーやロールに許可するなどの IAM ポリシーを設定できる。
- 一方、ブラックリストパターンは、特定のユーザーやロールが特定の AWS リソースへのアクセスを拒否されるパターンを指す。例えば、特定の EC2 インスタンスへの書き込みアクセスを特定のユーザーやロールに拒否するなどの IAM ポリシーを設定できる。

# 課題 2

## 毎回ルートユーザとしてアクセスするのではなく、管理者権限の IAM ユーザでログインした方が良い理由

- ルートユーザーは請求情報を含むを含むすべての AWS のサービス のリソースへのフルアクセスが可能になるため日常的なタスクに使用してはいけない
- ルートユーザーは、ルートユーザーのみが実行できるタスクに使用する

参考：https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/best-practices.html#lock-away-credentials

## ひとつの IAM ユーザーを使い回さない方が良い理由

- 最小特権の原則（Principle of Least Privilege）: 各 IAM ユーザーは、その任務を遂行するために必要な最低限の権限のみを持つべき
- 一つの IAM ユーザーを使い回すと、そのユーザーは必要以上の権限を持つことになり、セキュリティのリスクが増える

## PowerUserAccess ポリシーを付与した IAM ユーザーが IAM ダッシュボードを表示した場合

下記のエラーが表示される

- iam:GetAccountSummary に対する許可がありません
- iam:ListMFADevices に対する許可がありません
- iam:ListAccessKeys に対する許可がありません
- iam:GetAccountSummary に対する許可がありません

### AdministratorAccess

- このポリシーを持つ IAM ユーザーは、AWS アカウント内のほぼすべてのリソースに対して完全なアクセス権限を持つ
- IAM ユーザー、グループ、ロールの管理など、IAM 関連の操作も含まれる
- つまり、このポリシーを付与されたユーザーは、AWS アカウントの全リソースに対する管理者権限を持つ

### PowerUserAccess

- このポリシーを持つ IAM ユーザーも、AWS アカウント内の多くのリソースに対する広範なアクセス権限を持ちますが、「AdministratorAccess」ポリシーと異なり、IAM 関連の操作が制限される
- つまり、他の IAM ユーザー、グループ、またはロールの作成や管理は行えない
- これは、ユーザーが他の IAM エンティティに対して権限をエスカレーションすることを防ぐための制限となる

PowerUserAccess ポリシーは、AWS リソースの大部分に対するアクセスを必要としながらも IAM 操作は制限したいという場合に適している。
それに対し、AdministratorAccess ポリシーは、IAM 操作も含む全ての AWS リソースへのフルアクセスが必要なユーザーに適している。

## AdministratorAccess ポリシーを直接ユーザに付与する方法と、グループに付与してユーザを所属させる方法はどちらが適切か？

- AWS のベストプラクティスとしては、IAM ユーザーに直接ポリシーを付与するよりも、IAM グループを利用して権限を管理する方が推奨されている
- 一貫性のある権限管理を保つとともに、権限の変更や管理の効率化にも寄与するため

## EC2 インスタンスにロールを付与するべきか直接ポリシーを付与するべきか

- EC2 インスタンスに直接 IAM ポリシーを付与することはできない

## IAM の「Resource based」と「Identity based」ポリシーについて

### Identity-Based ポリシー

- これは IAM エンティティ（ユーザー、グループ、ロール）に直接付与されるポリシー
- このタイプのポリシーを使用して、エンティティが実行できるアクションとアクセスできるリソースを制御する
- 例えば、「この IAM ユーザーは S3 バケットに対して読み取り/書き込みを行うことができる」といったポリシーを Identity-Based ポリシーとして設定することができる
  Identity-Based ポリシーは、各 IAM エンティティが何ができるかを中心に管理を行いたい場合に便利

### Resource-Based ポリシー

- これは AWS リソースに直接付与されるポリシーで、そのリソースに対してどの IAM エンティティがどのようなアクションを行えるかを定義する
- Resource-Based ポリシーでは、"Principal" という要素を使って、どの IAM エンティティが許可されるかを定義する
- 一部の AWS サービス（例えば S3, SNS, SQS など）では、リソースに直接ポリシーを付与することができる
- 特定のリソースが誰からアクセスされるべきかを中心に考えたい場合に便利

## S3 を意図しないアクセスから守るため IAM 以外に設定しておいた方が良い項目

### S3 バケットポリシー

- 特定の IP アドレスからのアクセスのみを許可するといった制御が可能

### S3 Block Public Access

- S3 バケットまたはアカウント全体でパブリックアクセスを一括で制限する機能
- 有効にすると、バケットポリシーや ACL による公開設定を無効化することができ、意図しない公開を防ぐことができる。

## アクセス制御の「ホワイトリスト方式」「ブラックリスト方式」と呼ばれる設計方針

### ホワイトリスト方式

- メリット

  - 一定のリソースに対するアクセスは、明示的に許可されたものだけ
  - ホワイトリスト方式は厳格なアクセス制御を提供し、安全性が高い
  - 新たに追加されたリソースは、デフォルトでブロックされるため、意図しない公開を防ぐことができる

- デメリット

  - アクセスを許可する全てのエンティティやアクションを明示的にリストに追加する必要がある
  - 管理が煩雑になり、大規模なシステムでは効率的に管理するのが難しい場合もある
  - 例：AWS の IAM ポリシーでは、通常、ホワイトリスト方式が推奨される

### ブラックリスト方式

- メリット

  - 全てのエンティティやアクションはデフォルトで許可され、明示的に禁止されたものだけがブロックされる
  - これにより、システムの新たな機能やリソースが追加されたときに、それらへのアクセスを即座に可能にすることができる

- デメリット

  - 新たに追加されたリソースがデフォルトで公開されるため、意図しない公開が起こるリスクがある
  - また、全てを許可するという方針がセキュリティ上問題となる場合もある
  - 例：S3 バケットポリシーでは、特定の IP アドレスからのアクセスをブロックする（ブラックリストに追加する）などが可能

### PostgreSQL の RLS（Row Level Security）

- ホワイトリスト方式に近い
- 特定のユーザーが特定の行に対してアクセスできるように設定するため、許可されたものだけがアクセス可能となる

## AWS でリソースに対するルールの自動チェックを行ってくれるサービス

### AWS Config

AWS リソースに関する設定を監視、評価、および監査するためのサービスで、設定が所望のルールに準拠しているかどうかを確認することができる
AWS Config は以下のような機能を提供する

- リソースインベントリ: AWS アカウント内のリソースを確認し、各リソースの詳細情報を表示する
- 設定履歴: 特定のリソースに対して行われた設定変更の詳細な履歴を表示する
- 設定変更通知: AWS リソースの設定が変更されたときに SNS トピックに通知する
- 設定ルール: リソースの設定が所望のルールに準拠しているかどうかを評価する。準拠していないリソースは、ダッシュボードに警告として表示される。

### AWS Security Hub

- AWS のセキュリティアラートとセキュリティ状態の情報を集約し、これらの情報を統合的に管理し、可視化することができるツール
- Security Hub は、自動的に AWS アカウント内のリソースをチェックし、主要なセキュリティ基準（CIS AWS Foundations Benchmark など）に準拠しているかを評価する

# 課題３

IAM ポリシーで条件を指定して、アクセスをさらに制限することは可能ですか？
